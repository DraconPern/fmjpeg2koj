image: Visual Studio 2017

configuration:
  - Release

install:
  - SET TYPE=%CONFIGURATION%
  - SET DEVSPACE=%APPVEYOR_BUILD_FOLDER%\..
  - SET GENERATOR="Visual Studio 15 2017"
  
# dcmtk & zlib
  - cd %DEVSPACE%
  - git clone --branch=DCMTK-3.6.5 --single-branch --depth 1 https://github.com/DCMTK/dcmtk.git
  - cd dcmtk && mkdir build-%TYPE% && cd build-%TYPE%
  - cmake .. -G %GENERATOR% -DDCMTK_ENABLE_CXX11=ON -DDCMTK_ENABLE_STL=ON -DDCMTK_WIDE_CHAR_FILE_IO_FUNCTIONS=1 -DDCMTK_WITH_ZLIB=1 -DWITH_ZLIBINC=%DEVSPACE%\zlib\%TYPE% -DDCMTK_WITH_ICONV=1 -DWITH_LIBICONVINC=%DEVSPACE%\libiconv\%TYPE% -DCMAKE_INSTALL_PREFIX=%DEVSPACE%\dcmtk\%TYPE%
  - powershell "gci config\include\dcmtk\config osconfig.h | ForEach { (Get-Content $_.FullName | ForEach {$_ -replace '/\* #undef HAVE_SSL_CTX_GET0_PARAM \*/', '#define HAVE_SSL_CTX_GET0_PARAM'}) | Set-Content $_.FullName }"
  - msbuild /maxcpucount:8 /P:Configuration=%TYPE% INSTALL.vcxproj

# openjpeg
  - cd %DEVSPACE%
  - git clone --branch=v2.4.0 --single-branch --depth 1 https://github.com/uclouvain/openjpeg.git
  - cd openjpeg && mkdir build-%TYPE% && cd build-%TYPE%
  - cmake .. -G %GENERATOR% -DBUILD_THIRDPARTY=ON -DBUILD_SHARED_LIBS=OFF -DCMAKE_C_FLAGS_RELEASE="/MT /O2 /D NDEBUG" -DCMAKE_C_FLAGS_DEBUG="/D_DEBUG /MTd /Od" -DCMAKE_INSTALL_PREFIX=%DEVSPACE%\openjpeg\%TYPE%
  - msbuild /P:Configuration=%TYPE% INSTALL.vcxproj
 
before_build:
  - cd %APPVEYOR_BUILD_FOLDER% && mkdir build-%TYPE% && cd build-%TYPE%
  - cmake .. -G %GENERATOR% -DBUILD_SHARED_LIBS=OFF -DCMAKE_CXX_FLAGS_RELEASE="/MT /O2 /D NDEBUG" -DCMAKE_CXX_FLAGS_DEBUG="/D_DEBUG /MTd /Od" -DOPENJPEG=%DEVSPACE%\openjpeg\%TYPE% -DDCMTK_DIR=%DEVSPACE%\dcmtk\%TYPE% -DCMAKE_INSTALL_PREFIX=%APPVEYOR_BUILD_FOLDER%\%TYPE%

build_script:
  - cd %APPVEYOR_BUILD_FOLDER%\build-%TYPE%
  - msbuild /P:Configuration=%TYPE% INSTALL.vcxproj

after_build:
  - cd %DEVSPACE%
  - 7z a fmjpeg2koj-win.7z fmjpeg2koj\%TYPE% openjpeg\%TYPE%
  - mv fmjpeg2koj-win.7z %APPVEYOR_BUILD_FOLDER%

artifacts:
  - path: fmjpeg2koj-win.7z
    name: fmjpeg2koj-win
 
deploy:
  provider: S3
  access_key_id:
    secure: NoQGGjuA1OWCnB7LiTCQDw19+jVRaveK8QbFY+FSVEg=
  secret_access_key:
    secure: quY6Ltwn2DiEWqh48ZIFIqx50TduHHKbcRrunpiEzcRZIIsUohb5Y5viJ/TkPzUj
  bucket: draconpern-buildcache
  set_public: true
  folder: 
  artifact: fmjpeg2koj-win
 